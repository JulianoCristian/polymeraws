<!doctype html>

<html>
  <head>
    <title>aws-dynamodb tests</title>
    <met charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1, user-scalable=yes">
    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../web-component-tester/browser.js"></script>

    <link rel="import" href="../aws-dynamodb.html">
  </head>
  <body>

    <test-fixture id="Basic">
      <template>
        <aws-dynamodb table-name="testTable" limit="1" consistent-read></aws-dynamodb>
      </template>
    </test-fixture>

    <test-fixture id="Empty">
      <template>
        <aws-dynamodb></aws-dynamodb>
      </template>
    </test-fixture>

    <test-fixture id="Format">
      <template>
        <aws-dynamodb table-name="testTable" limit="1" format-data></aws-dynamodb>
      </template>
    </test-fixture>

    <test-fixture id="Query">
      <template>
        <aws-dynamodb table-name="testTable" operation="query"></aws-dynamodb>
      </template>
    </test-fixture>

    <script>
      var AWS = {};

      var testData = {
        Count: 1,
        Items: [{
          id: {
            N: 1
          },
          title: {
            S: 'Test Note #1'
          },
          shared: {
            BOOL: 'true'
          },
          likeCount: {
            N: 3
          },
          content: {
            S: 'Content of test note #1'
          }
        }],
        LastEvaluatedKey: {
          id: {
            N: 1
          }
        },
        ScannedCount: 1
      };

      suite('<aws-dynamodb>', function() {
        var dynamoDbElement;

        suite('attached', function() {
          setup(function() {
            AWS.DynamoDB = sinon.stub().returns({
              scan: function () {},
              query: function () {}
            });

            dynamoDbElement = fixture('Basic');
          });

          test('constructs a service interface object', function() {
            expect(AWS.DynamoDB).to.be.calledOnce;
          });
        });

        suite('change table', function() {
          setup(function() {
            AWS.DynamoDB = function DynamoDB() {
              this.scan = sinon.stub().callsArgWith(1, null, {});
            };
            dynamoDbElement = fixture('Empty');
            dynamoDbElement.set('tableName', 'testTable');
          });

          test('performs a scan', function() {
            expect(dynamoDbElement._dynamoDBRef.scan).to.be.calledWith({
              TableName: 'testTable',
              Limit: 100,
              ConsistentRead: false
            });
          });
        });

        suite('change operation', function() {
          setup(function() {
            AWS.DynamoDB = function DynamoDB() {
              this.scan = sinon.stub().callsArgWith(1, null, {});
              this.query = sinon.stub().callsArgWith(1, null, {});
            };
            dynamoDbElement = fixture('Basic');
          });

          test('performs a query', function() {
            dynamoDbElement.set('operation', 'query');
            expect(dynamoDbElement._dynamoDBRef.query).to.be.calledWith({
              TableName: 'testTable',
              Limit: 1,
              ConsistentRead: true
            });
          });
        });

        suite('retrieve data', function() {
          setup(function() {
            AWS.DynamoDB = function DynamoDB() {
              this.scan = sinon.stub().callsArgWith(1, null, testData);
            };
            dynamoDbElement = fixture('Basic');
          });

          test('uses consistent reads', function() {
            expect(dynamoDbElement._dynamoDBRef.scan).to.be.calledWith({
              TableName: 'testTable',
              Limit: 1,
              ConsistentRead: true
            });
          });

          test('limits the number of returned items to 1', function() {
            expect(dynamoDbElement.data.length).to.equal(1);
            expect(dynamoDbElement.data).to.deep.equal([{
              id: {
                N: 1
              },
              title: {
                S: 'Test Note #1'
              },
              shared: {
                BOOL: 'true'
              },
              likeCount: {
                N: 3
              },
              content: {
                S: 'Content of test note #1'
              }
            }]);
          });

          test('load next page', function() {
            dynamoDbElement.nextPage();
            expect(dynamoDbElement._dynamoDBRef.scan).to.be.calledWith({
              TableName: 'testTable',
              Limit: 1,
              ConsistentRead: true,
              ExclusiveStartKey: {
                id: {
                  N: 1
                }
              }
            });
          });
        });

        suite('query data', function () {
          setup(function() {
            AWS.DynamoDB = function DynamoDB() {
              this.scan = sinon.stub().callsArgWith(1, null, {});
              this.query = sinon.stub().callsArgWith(1, null, {});
            };
            dynamoDbElement = fixture('Query');
          });

          test('query primary index', function() {
            dynamoDbElement.set('conditions', [{
              id: {
                condition: '=',
                value: 2
              }
            }]);

            expect(dynamoDbElement._dynamoDBRef.query).to.be.calledWith({
              TableName: 'testTable',
              Limit: 100,
              ConsistentRead: false,
              ExpressionAttributeNames: {
                '#id': 'id'
              },
              ExpressionAttributeValues: {
                ':id': {
                  N: '2'
                }
              },
              KeyConditionExpression: '#id = :id'
            });
          });

          test('query secondary index', function() {
            dynamoDbElement.set('indexName', 'title-index');
            dynamoDbElement.set('conditions', [{
              title: {
                condition: '=',
                value: 'Test Note #2'
              }
            }]);

            expect(dynamoDbElement._dynamoDBRef.query).to.be.calledWith({
              TableName: 'testTable',
              Limit: 100,
              ConsistentRead: false,
              ExpressionAttributeNames: {
                '#title': 'title'
              },
              ExpressionAttributeValues: {
                ':title': {
                  S: 'Test Note #2'
                }
              },
              KeyConditionExpression: '#title = :title',
              IndexName: 'title-index'
            });
          });

          test('does not set condition if value is empty', function() {
            dynamoDbElement.set('conditions', [{
              test: {
                condition: '='
              }
            }]);

            expect(dynamoDbElement._params.KeyConditionExpression).to.be.empty;
            expect(dynamoDbElement._params.ExpressionAttributeNames).to.be.empty;
            expect(dynamoDbElement._params.ExpressionAttributeValues).to.be.empty;
          });

          test('does not set condition if condition is empty', function() {
            dynamoDbElement.set('conditions', [{
              test: {
                value: 'value'
              }
            }]);

            expect(dynamoDbElement._params.KeyConditionExpression).to.be.empty;
            expect(dynamoDbElement._params.ExpressionAttributeNames).to.be.empty;
            expect(dynamoDbElement._params.ExpressionAttributeValues).to.be.empty;
          });
        });

        suite('format data', function () {
          setup(function() {
            AWS.DynamoDB = function DynamoDB() {
              this.scan = sinon.stub().callsArgWith(1, null, testData);
            };
            dynamoDbElement = fixture('Format');
          });

          test('formats returned data', function() {
            expect(dynamoDbElement.data).to.deep.equal([{
              id: 1,
              title: 'Test Note #1',
              shared: true,
              likeCount: 3,
              content: 'Content of test note #1'
            }]);
          });
        });

        suite.skip('update record', function() {

        });

        suite.skip('add record', function() {

        });
      });
    </script>
  </body>
</html>