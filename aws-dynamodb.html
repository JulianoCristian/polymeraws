<link rel="import" href="../polymer/polymer.html">

<!--
`aws-dynamodb`
Polymer Web Component for AWS DynamoDB
-->

<dom-module id="aws-dynamodb">
  <script>
    (function () {
      'use strict';

// @todo:
// - option to override region (because of endpoint)?
// - add readonly option to prevent writing on binding?
// - limit and offset

      /**
       * The `aws-dynamodb` element is an easy way to retrieve and update
       * AWS DynamoDB data.
       *
       * Example usage:
       *
       * ```html
       * <aws-app
       *      region="eu-west-1">
       * </aws-app>
       * <aws-dynamodb
       *      table-name="notes"
       *      data="{{data}}">
       * </aws-dynamodb>
       * ```
       *
       * The 'aws-dynamodb' element initializes `AWS` in `aws-dynamodb`.
       */
      Polymer({
        is: 'aws-dynamodb',

        properties: {
          /**
           * Operation's response
           *
           * This will be update every time the operation or query changes, changes
           * to this object will result in updates inside the database
           */
          data: {
            type: Object,
            notify: true
          },

          /**
           * Whether data response data should be parsed
           *
           * If this is true the returned data will not contain the attribute types:
           * `S, N, B, SS, NS, BS, M, L, NULL, BOOL`.
           */
          formatData: {
            type: Boolean,
            value: false
          },

          /**
           * The maximum number of records to retrieve for a scan or query
           */
          limit: {
            type: Number,
            value: 100
          },

          /**
           * The operation which is used for getting items from the DynamoDB
           *
           * The only accepted values are `scan` and `query`
           */
          operation: {
            type: String,
            value: 'scan',
            observer: '_getData'
          },

          /**
           * The name of the DynamoDB Table
           *
           * For example: 'notes'
           */
          tableName: {
            type: String,
            value: ''
          },

          _dynamoDBRef: {
            type: Object,
            observer: '_getData'
          },

          _lastEvaluatedKey: {
            type: Object
          },

          _params: {
            type: Object
          }
        },

        observers: [
          '_computeParams(tableName, limit)'
        ],

        attached: function() {
          this._dynamoDBRef = new AWS.DynamoDB();
        },

        /**
         * Adds the record to the table
         *
         * @param   {Object} record The record that should be added to the table.
         */
        addRecord: function(record) {
// @todo: implement
        },

        /**
         * Load the next page of results
         *
         * There is no previousPage functionality, it is advisable to cache the
         * previous results locally.
         *
         * @return  {Boolean} Boolean being true if the next page will be loaded
         * and false if there is no next page.
         */
        nextPage: function() {
          if (this._lastEvaluatedKey !== null) {
            this.set('_params.ExclusiveStartKey', this._lastEvaluatedKey);
            this._getData();
            return true;
          } else {
            return false;
          }
        },

        /**
         * Updates the given record in the table
         *
         * @param   {Number} index The index of the record in the table.
         * @param   {Object} record The updated record.
         */
        updateRecord: function(index, record) {
// @todo: implement
        },

        _computeParams: function(table, limit) {
          if (table !== '') {
            this.set('_params', {
              TableName: table,
              Limit: limit
            });

            if (this._isOperationValid(this.operation)) {
              this._getData();
            }
          }
        },

        _getData: function() {
          if (!this._isOperationValid(this.operation)) {
            throw new Error('Operation `' + this.operation + '` is not a valid operation');
          }

          if (this._dynamoDBRef && this._params) {
            this._dynamoDBRef[this.operation](
              this._params,
              this._handleResponse.bind(this)
            );
          }
        },

        _handleResponse: function(error, data) {
          if (error) {
            throw new Error('Could not retrieve data from DynamoDB because: ' + error);
          }

          this.set('_lastEvaluatedKey', data.LastEvaluatedKey);

          if (this.formatData) {
            for (var i = 0, length = data.Items.length; i < length; i++) {
              data.Items[i] = this._parseItem(data.Items[i]);
            }

            this.set('data', data.Items);
          } else {
            this.set('data', data.Items);
          }
        },

        _isOperationValid: function(operation) {
          return operation === 'scan' || operation === 'query';
        },

        // http://docs.aws.amazon.com/amazondynamodb/latest/APIReference/API_AttributeValue.html
        _parseItem: function(item) {
          var parsed = {};

          for (var j in item) {
            var type = Object.keys(item[j])[0];
            parsed[j] = item[j][type];

            if (type === 'N') {
              parsed[j] = parseFloat(item[j].N);
            }

            if (type === 'BOOL') {
              if (parsed[j].BOOL === 'true' || parsed[j].BOOL === true) {
                parsed[j] = true;
              } else {
                parsed[j] = false;
              }
            }
          }

          return parsed;
        }
      });
    })();
  </script>
</dom-module>