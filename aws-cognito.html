<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../log-behavior/log-behavior.html">
<link rel="import" href="./aws-cognito-script.html">

<!--
`<aws-cognito>` provides API wrapping and Polymer data binding for Amazon's
Cognito service.

Example usage:

```html
<aws-app
    region="us-east-1">
<aws-cognito id="cognito"
    user-pool-id="us-east-1_XXXXXXXXX"
    client-id="3XXXXXfea3nXXX0k3XXXXXX9p5"
    identity-pool-id="us-east-1:XXXXXXXX-XXXX-XXXX-XXXX-XXXXAXXXXXXX"
    user="{{user}}"
    attributes="{{attributes}}"
></aws-cognito>
```
-->

<dom-module id="aws-cognito">
  <script>
    Polymer({
      is: 'aws-cognito',
      properties: {

        /**
         * The optional AWS region Cognito should run in.
         *
         * Example: `us-east-1`
         *
         * @type: {string}
         */
        region: String,

        /**
         * The Cognito User Pool ID.
         *
         * Example: 'us-east-1_XXXXXXXXX'
         *
         * @type: {string}
         */
        userPoolId: String,

        /**
         * The Cognito App client id.
         *
         * Example: 'XXXXXXXXXXXXXXXXXXXXXXXXXX'
         *
         * @type {string}
         */
        clientId: String,

        /**
         * The Cognito identity pool ID.
         *
         * Example: 'us-east-1:XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX'
         *
         * @type: {string}
         */
        identityPoolId: String,

        /**
         * Whether or not to periodically try to refresh user session.
         */
        noAutoRefresh: {
          type: Boolean,
          value: false,
        },

        /**
         * The currently authenticated user, with attributes.
         */
        user: {
          type: Object,
          readOnly: true,
          notify: true,
        },

        /**
         * Array of Cognito user attributes
         */
        attributes: {
          type: Array,
          readOnly: true,
          notify: true,
        },

        /**
         * The User's AWS Credentials.
         */
        credentials: {
          type: Object,
          readOnly: true,
          notify: true,
        },

        /**
         * The authenticated user's cognito IdentityId
         */
        identityId: {
          type: String,
          readOnly: true,
          notify: true,
        },

        /**
         * True when waiting for a response from Cognito.
         * e.g. after submitting login request
         */
        loading: {
          type: Boolean,
          readOnly: true,
          notify: true,
        },

        /**
         * Whether or not a user is logged in.
         */
        loggedIn: {
          type: Boolean,
          readOnly: true,
          value: false,
          notify: true,
          observer: '_loggedInChanged',
        },

        /**
         * Array of objects representing identity providers. e.g.
         * {url: 'login.provider.com', token: 'the provider token'}
         */
        providers: {
          type: Array,
          value: () => [],
        },

        /**
         * The interval, in minutes, at which to try to refresh user session.
         */
        refreshUserInterval: {
          type: Number,
          value: 20,
        },

        /**
         * The Cognito session
         */
        session: {
          type: Object,
          readOnly: true,
          notify: true,
        },

        /**
         * Indicates whether or not `<aws-cognito>` will attempt to refresh the
         * Cognito user at the end of the current interval.
         */
        _shouldRefreshUser: {
          type: Boolean,
          observer: '_onShouldRefreshUserChange',
        },
      },

      behaviors: [
        PolymerElements.LogBehavior,
      ],

      observers: [
        '_userChanged(user, identityId)',
        '_attributesChanged(attributes)',
        '_providersChanged(providers, providers.*)',
      ],

      ready: function() {
        this._log.debug(this.localName + ' is ready');
        this._initCognito();
      },

      /**
       * Signs a user up to a Cognito app.
       *
       * @param  {String} username           The username
       * @param  {String} password           The password.
       * @return {Promise.<CognitoSession>}  A promise that resolves to
       *                                     the Cognito session.
       */
      signup: function(username, password) {
        this._log.info(`Trying to sign up ${username}`);
        this._setLoading(true);
        const userPool = this._getCognitoUserPool();
        let attributeList = [];

        let dataUsername = {
            Name: 'email',
            Value: username,
        };

        let attributeEmail = new AWSCognito
          .CognitoIdentityServiceProvider.CognitoUserAttribute(dataUsername);

        attributeList.push(attributeEmail);

        return new Promise((resolve, reject) => {
          userPool
            .signUp(username, password, attributeList, null, (error, result) => {
            this._setLoading(false);
            if (error) {reject(error);}
            if (result) {resolve(result);}
          });
        });
      },

      /**
       * Verifies a new user based on their input.
       *
       * @param  {String} username             The username
       * @param  {String} code The confirmation code sent to the user.
       * @return {Promise.<String>} Promise which resolves to AWS Cognito's success message.
       * @fires confirm-success
       * @fires confirm-error
       */
      verify: function(username, code) {
        this._log.debug(`Trying to confirm registration of ${username}`);
        const userPool = this._getCognitoUserPool();
        const cognitoUser = this._getCognitoUser(username, userPool);
        return new Promise((resolve, reject) => {
          this._setLoading(true);
          cognitoUser.confirmRegistration(code, true, (error, result) => {
            this._setLoading(false);
            if (error) {
              reject(error);
              this.dispatchEvent(new CustomEvent('confirm-failure', {
                detail: error, bubbles: true, composed: true,
              }));
            }
            else {
              resolve(result);
              this.dispatchEvent(new CustomEvent('confirm-success', {
                detail: result, bubbles: true, composed: true,
              }));
            }
          });
        });
      },

      /**
       * Tries to log a user in to AWS Cognito.
       *
       * @param  {String} username The username
       * @param  {String} password The user's password.
       * @return {Promise.<{"message": string,"username": string}>}
       *         A promise that resolves to
       *         an object containing a success message and the username.
       * @fires login-failure
       */
      login: function(username, password) {
        this._log.info(`Trying to login ${username}`);
        return new Promise((resolve, reject) => {
          const userPool = this._getCognitoUserPool();
          let cognitoUser = this._getCognitoUser(username, userPool);
          this._authenticateUser(username, password)
          .then(this.refreshCredentials())
          .then(() => {
            this._setIdentityId(AWS.config.credentials.params.IdentityId);
            this._setUser(this._getCognitoUser(username, userPool));
            this._setLoggedIn(true);
            this._getCognitoAttributes(cognitoUser);
          })
          .then((attributes) => {
            this._setAttributes(attributes);
            // Begin automatically refreshing user unless asked not to
            this._shouldRefreshUser = this.noAutoRefresh ? false : true;
            this.dispatchEvent(new CustomEvent('login-success', {
              detail: username, bubbles: true, composed: true,
            }));
            resolve({message: 'Successfully logged In', username: username});
          })
          .catch((error) => {
            this._handleError(error);
            this.dispatchEvent(new CustomEvent('login-failure', {
              detail: error, bubbles: true, composed: true,
            }));
          });
        });
      },

      /**
       * Logs a user out of a Cognito app,
       * then nullifies and dispatches the user object.
       *
       * @param  {CognitoUser} cognitoUser The Cognito user.
       */
      logout: function(cognitoUser) {
        this._log.info(`Logging out user ${cognitoUser.username}`);
        this._shouldRefreshUser = false;
        cognitoUser.signOut();
        AWS.config.credentials.clearCachedId(); // https://github.com/aws/aws-sdk-js/issues/609
        AWS.config.credentials = {};
        cognitoUser = null;
        this.loggedIn = false;
        this.providers.forEach(() => this.pop('providers'));
        this._setIdentityId(null);
        this._setLoggedIn(false);
        this._setUser({username: null});
        this._setLoading(false);
      },

      /**
       * Tries to recover a user session from localStorage. If user is recovered
       * successfully, will optionally initiate automatic credential refreshing.
       *
       * @return {Promise.<Error>}  A promise that rejects with
       *                            Cognito's error message if recovery failed.
       */
      recoverUser: function() {
        this._log.info(`Trying to recover Cognito user session`);
        const userPool = this._getCognitoUserPool();
        const cognitoUser = userPool.getCurrentUser();
        return new Promise((resolve, reject) => {
          this._setLoading(true);
          if (!cognitoUser) {
            let msg = 'No Cognito user found while trying to recover';
            this._log.warn(msg);
            resolve(msg);
            this._setLoading(false);
          } else {
            const username = cognitoUser.username;
            this._log.info( `Cognito user ${cognitoUser.username} found. Trying to recover` );
            this._getCognitoSession(cognitoUser)
            .then((cognitoSession) => this._integrateUser(cognitoSession))
            .then(this.refreshCredentials())
            .then((credentials) => {
              this._setLoading(false);
              this._setUser(this._getCognitoUser(username, userPool)); // Refresh the user obj
              this._setLoggedIn(true);
              this._shouldRefreshUser = !this.noAutoRefresh? true : false;
              this._setIdentityId(AWS.config.credentials.params.IdentityId);
              this.dispatchEvent(new CustomEvent('restore-session-success', {
                detail: username, bubbles: true, composed: true,
              }));
              this._getCognitoAttributes(cognitoUser)
              .then((attributes) => this._setAttributes(attributes));
              resolve(cognitoUser);
            })
            .catch((error) => {
              this._setLoading(false);
              this.dispatchEvent(new CustomEvent('restore-session-failure', {
                detail: username, bubbles: true, composed: true,
              }));
              reject(error);
            });
          }
        });
      },

      /**
       * Refreshes the user's credentials
       * @return {Promise} promise resolves to user's credentials
       */
      refreshCredentials: function() {
        this._log.info('Trying to refresh credentials');
        return new Promise((resolve, reject) => {
          this._refreshCognitoCredentials().then((credentials) => {
            this._setCredentials(credentials);
            resolve(credentials);
          }).catch((error) => this._handleError(error));
        });
      },

      /**
       * Returns a promise for the current user's attributes.
       * @return {Promise.<CognitoAttributes>} The user's attributes.
       */
      getAttributes: function() {
        const userPool = this._getCognitoUserPool();
        const cognitoUser = userPool.getCurrentUser();

        return new Promise((resolve, reject) => {
          this._getCognitoAttributes(cognitoUser)
          .then((attributes) => {
            this._setAttributes(attributes);
            resolve(attributes);
          })
          .catch((error) => reject(error));
        });
      },

      /**
       * Resends the user's verification code.
       *
       * @param  {String} username                The username
       * @return {Promise.<CodeDeliveryDetails>}  A promise that resolves to
       *                                          the code delivery details.
       */
      resendVerificationCode: function(username) {
        this._log.debug(`Trying to resend confirmation code for ${username}`);
        const userPool = this._getCognitoUserPool();
        const cognitoUser = this._getCognitoUser(username, userPool);
        return new Promise((resolve, reject) => {
          this._setLoading(true);
          cognitoUser.resendConfirmationCode((error, result) => {
            if (error) {
              this._setLoading(false);
              reject(error);
            }
            else {
              this._setLoading(false);
              resolve(result);
            }
          });
        });
      },

      /**
       * Requests a password reset code for a username.
       * @param  {String} username The username
       * @return {Promise.<String>} Promise that resolves to the success message
       */
      requestPasswordResetCode: function(username) {
        this._log.debug(`Requesting password reset code for ${username}`);
        const userPool = this._getCognitoUserPool();
        const cognitoUser = this._getCognitoUser(username, userPool);
        return new Promise((resolve, reject) => {
          this._setLoading(true);
          cognitoUser.forgotPassword({
            onSuccess: (result) => {
              resolve(result);
              this._setLoading(false);
            },
            onFailure: (err) => {
              reject(err);
              this._setLoading(false);
            },
          });
        });
      },

      /**
       * Resets a user's password.
       * @param  {String} username The Username
       * @param  {String} password The new password
       * @param  {String} code     The verification code
       * @return {Promise.<String>} Promise that resolves to the success message
       */
      resetPassword: function(username, password, code) {
        this._log.debug(`Resetting password for ${username}`);
        const userPool = this._getCognitoUserPool();
        const cognitoUser = this._getCognitoUser(username, userPool);
        return new Promise((resolve, reject) => {
          this._setLoading(true);
          cognitoUser.confirmPassword(code, password, {
            onSuccess: () => {
              resolve('SUCCESS');
              this._setLoading(false);
            },
            onFailure: (err) => {
              reject(err);
              this._setLoading(false);
            },
          });
        });
      },

      /**
       * Since Amazon apps can run with Cognito in a different region than other
       * services, `_initCognito` first checks if a cognito=specific region was
       * defined before accepting the global AWS region.
       *
       * Sets up a credentials object which allows for unauthenticated Cognito roles.
       */
      _initCognito: function() {
        // Configure region
        const GLOBAL_REGION = AWSCognito.config.region || AWS.config.region;
        const CONFIGURED_REGION = this.region || GLOBAL_REGION;
        AWSCognito.config.region = CONFIGURED_REGION;
        // Initialize credentials
        const IdentityPoolId = this.identityPoolId;
        let credentials = new AWS.CognitoIdentityCredentials({IdentityPoolId});
            credentials.clearCachedId(); // https://github.com/aws/aws-sdk-js/issues/609
            credentials = new AWS.CognitoIdentityCredentials({IdentityPoolId});
        AWS.config.credentials = credentials;
        this.refreshCredentials();
      },

      /**
       * Gets a userPool object with User Pool ID and Client ID.
       *
       * @return {CognitoUserPool} The Cognito User Pool.
       */
      _getCognitoUserPool: function() {
        const USER_POOL_DATA = {
          UserPoolId: this.userPoolId,
          ClientId: this.clientId,
        };
        // const USER_POOL_URL = `cognito-idp${region}.amazonaws.com/${userPoolId}`;
        // NOTE: to use federated IDs, generate ARN and refer to it here.
        // see https://medium.com/@kangzeroo/user-management-with-aws-cognito-2-3-the-core-functionality-ec15849618a4#.l5h7n5gru
        let userPool = new AWSCognito.CognitoIdentityServiceProvider
          .CognitoUserPool(USER_POOL_DATA);
        return userPool;
      },

      /**
       * Gets a cognitoUser object from the pool.
       *
       * @param  {String}           username The username
       * @param  {CognitoUserPool}  userPool The Cognito user pool.
       * @return {CognitoUser}               The Cognito user.
       */
      _getCognitoUser: function(username, userPool) {
        var userData = {
          Username: username,
          Pool: userPool,
        };
        let cognitoUser = new AWSCognito.CognitoIdentityServiceProvider
          .CognitoUser(userData);
        return cognitoUser;
      },

      /**
       * Gets the session for a Cognito User.
       *
       * @param  {CognitoUser} cognitoUser    The Cognito user.
       * @return {Promise.<CognitoSession>}   A promise that resolves to
       *                                      the Cognito session.
       */
      _getCognitoSession: function(cognitoUser) {
        this._log.debug(`Trying to get Cognito session for ${cognitoUser.username}`);
        return new Promise((resolve, reject) => {
          cognitoUser.getSession((error, cognitoSession) => {
            if (error) reject(error);
            else {
              this._setSession(cognitoSession);
              resolve(cognitoSession);
            }
          });
        });
      },

      /**
       * Gets a logged-in user's Cognito attributes.
       *
       * @param  {CognitoUser}                 cognitoUser     The Cognito user.
       * @return {Promise.<CognitoAttributes>} A promise that resolves to
       *                                       an array of Attributes.
       */
      _getCognitoAttributes: function(cognitoUser) {
        this._getCognitoSession(cognitoUser);
        let name = cognitoUser.username;
        this._log.debug(`Trying to get Cognito attributes for ${name}`);
        return new Promise((resolve, reject) => {
          cognitoUser.getUserAttributes((error, attributes) => {
            if (error) {reject(error);}
            else {
              let parsedAttributes = {};
              for (var i = 0; i < attributes.length; i++) {
                parsedAttributes[attributes[i].Name] = attributes[i].Value;
              }
              resolve(parsedAttributes);
            }
          });
        });
      },

      /**
       * Gets current Cognito credentials.
       *
       * @return {CognitoCredentials} The credentials object.
       */
      _getCredentials: function() {
        const credentials = AWS.config.credentials;
        this._setCredentials(credentials);
        return credentials;
      },

      /**
       * Dispatches an error.
       *
       * @param  {Object} error Error object. Should contain `message` key.
       */
      _handleError: function(error) {
        error.bubbles = true;
        error.composed = true;
        this.dispatchEvent(new ErrorEvent('error', error));
      },

      /**
       * Tries to keep a user, credentials, attributes fresh
       * When _shouldRefreshUser is made false, clears the interval.
       *
       * @param  {Boolean} nv The new value.
       * @param  {Boolean} ov The old value.
       */
      _onShouldRefreshUserChange: function(nv, ov) {
        if (this._shouldRefreshUser === undefined) {return;}
        if (!nv && ov) {
          // Was true, now false i.e. stop refreshing
          if (this._refreshCognitoUserIntervalRef) {
            this._log.debug(`Clearing user refresh interval`);
            clearInterval(this._refreshCognitoUserIntervalRef);
          }
          this._refreshCognitoUserIntervalRef = undefined;
        } else if (!this._refreshCognitoUserIntervalRef && nv && !ov) {
          // Was false now true i.e. start refreshing
          let refreshCallback = () => {
            // Lets refresh this guy (or girl (or fish))
            const userPool = this._getCognitoUserPool();
            const cognitoUser = userPool.getCurrentUser();
            if (cognitoUser) {
              this._log.debug(`Trying to keep user ${cognitoUser.username} fresh`);
              this.refreshCredentials()
              .then((credentials) => this._log.debug(`Credential Expiry: ${credentials.expireTime}`))
              .catch((error) => this._log.error(error));
            }
          };
          let time = this.refreshUserInterval;
          this._log.debug(`Setting user refresh interval at ${time} minutes`);
          this._refreshCognitoUserIntervalRef = setInterval(refreshCallback,
            this.refreshUserInterval * 1000 * 60);
        }
      },

      _loggedInChanged: function(loggedIn) {
        if (loggedIn && !this.identityId) {
          this._setIdentityId(AWS.config.credentials.params.IdentityId);
        }
      },

      /**
       * Logs a user into a Cognito app.
       *
       * @param  {String} Username The username
       * @param  {String} Password The password.
       * @return {Promise.<cognitoSession>} A promise that resolves to
       *                                    the Cognito session.
       */
      _authenticateUser: function(Username, Password) {
        this._log.debug(`Trying to authenticate ${Username}`);
        const authenticationData = {Username, Password};
        const authenticationDetails = new AWSCognito.CognitoIdentityServiceProvider.AuthenticationDetails(authenticationData); // eslint-disable-line max-len
        const userPool = this._getCognitoUserPool();
        const cognitoUser = this._getCognitoUser(Username, userPool);
        return new Promise((resolve, reject) => {
          this._setLoading(true);
          cognitoUser.authenticateUser(authenticationDetails, {
            onSuccess: (cognitoSession) => {
              this._setLoading(false);
              this._integrateUser(cognitoSession);
              this.refreshCredentials().then(resolve(cognitoSession));
            },
            onFailure: (error) => {
              this._setLoading(false);
              reject(error);
            },
          });
        });
      },

      /**
       * Recovers or refreshes a Cognito user.
       *
       * @param  {CognitoUser} cognitoUser The Cognito user to refresh or recover.
       * @return {Promise.<Boolean>}       A promise that resolves to
       *                                   `true` if the user was successfully
       *                                   refreshed..
       */
      _recoverUser: function(cognitoUser) {
        return new Promise((resolve, reject) => {
          this._getCognitoSession(cognitoUser)
          .then((cognitoSession) => {
            this.refreshCredentials()
            .then((credentials) =>
              resolve(credentials, cognitoUser, cognitoSession));
          }).catch((error) => reject(error));
        });
      },

      /**
       * Refreshes the user's Cognito credentials.
       *
       * @return {Promise.<CognitoCredentials>} A promise that resolves to
       *                                        the user's Cognito credentials.
       */
      _refreshCognitoCredentials: function() {
        return new Promise((resolve, reject) => {
          const creds = this._getCredentials();
          if (!creds.refresh) resolve(creds);
          else creds.refresh((err) => err ? reject(err) : resolve(creds));
        });
     },

      /**
       * Dispatches an event containing all Cognito user data.
       *
       * @param  {CognitoUser}  cognitoUser The Cognito user.
       * @param  {String}       identityId  The user's identityId.
       * @fires  cognito-user
       */
      _userChanged: function(cognitoUser, identityId) {
        if (AWS.config.credentials) {
          this._log.debug(`Dispatching Cognito user ${cognitoUser.username}`);
          this.dispatchEvent(new CustomEvent('cognito-user', {
            detail: {user: cognitoUser, identityId}, bubbles: true, composed: true,
          }));
        } else {
          throw new Error('No Cognito user credentials found while dispatching user');
        }
      },

      /**
       * Dispatches an event containing updated user attributes.
       *
       * @param  {CognitoAttributes} attributes The updated attributes.
       * @fires  cognito-attributes
       */
      _attributesChanged: function(attributes) {
        this._log.debug(`Dispatching Cognito attributes`);
        this.dispatchEvent(new CustomEvent('cognito-attributes', {
          detail: attributes, bubbles: true, composed: true,
        }));
      },

      _providersChanged: function(providers) {
        if (!providers || !providers.length) return;
        let Logins = {};
        for (let provider of providers) {
          Logins[provider.url] = provider.token;
        }
        const IdentityPoolId = this.identityPoolId;
        const credentials = {IdentityPoolId, Logins};
        const newCredentials = new AWS.CognitoIdentityCredentials(credentials);
        AWS.config.credentials = newCredentials;
        this.refreshCredentials();
      },

      },
    });
    /**
     * @typedef {Object} CognitoUser
     */

    /**
     * @typedef {Object} CognitoSession
     */

    /**
     * @typedef {Object} CognitoUserPool
     */

    /**
     * @typedef {Object.<string, string>} CognitoAttributes
     */

    /**
     * @typedef {Object} CognitoCredentials
     */

    /**
     * @typedef {{
     *   "AttributeName": String,
     *   "DeliveryMedium": String,
     *   "Destination": String
     * }} CodeDeliveryDetails
     */

    /**
     * Fired when the user is updated by Cognito.
     *
     * @event cognito-user
     * @property {String}       username.
     * @property {CognitoUser}  Cognito user.
     * @property {String}       User's Cognito IdentityId.
     */

    /**
     * Fired when the user attributes are updated by Cognito.
     *
     * @event cognito-attributes
     * @property {Object}       Attributes.
     */

    /**
     * Fired when a user successfully logs in
     *
     * @event login-success
     * @property {String}  username
     */

    /**
     * Fired when a user fails to log in
     *
     * @event login-failure
     * @property {Object}  Error.
     */

    /**
     * Fired when a user session is successfully restored
     *
     * @event restore-session-success
     * @property {String}  username
     */

    /**
     * Fired when a user sesssion fails to restore
     *
     * @event restore-session-failure
     * @property {Object}  Error.
     */

    /**
     * Fired when user confirmation succeeds.
     *
     * @event confirm-success
     * @property {Object}       Success message.
     */

    /**
     * Fired when user confirmation fails.
     *
     * @event confirm-failure
     * @property {Object}       Failure message.
     */
  </script>
</dom-module>
