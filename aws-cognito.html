<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="aws-cognito-script.html">

<!--
`aws-cognito`
Polymer Web Component for AWS Cognito
-->

<dom-module id="aws-cognito">
  <script>
    (function () {
      'use strict';

      /**
       * The `aws-cognito` element is a wrapper around the AWS Cognito service. It
       * notifies successful authentication and provides user information.
       *
       * Example usage:
       *
       * ```html
       * <aws-app
       *     region="eu-west-1">
       * </aws-app>
       * <aws-cognito
       *     id="cognito"
       *     user="{{user}}"
       *     provider="google"
       *     on-error="handleError">
       * </aws-cognito>
       * ```
       *
       * The `aws-app` element initializes `AWS` in `aws-cognito`.
       *
       * JavaScript sign-in calls can then be made to the `aws-cognito` object
       * to attempt authentication, e.g.:
       *
       * ```javascript
       * this.$.cognito.signIn();
       * ```
       */
      Polymer({
        is: 'aws-cognito',

        properties: {
          userPoolId: {
            type: String,
            value: ''
          },
          userPoolClientId: {
            type: String,
            value: ''
          },
          identityPoolId: {
            type: String,
            observer: '_authenticate'
          },
          signedIn: {
            type: Boolean,
            notify: true,
            readonly: true,
            value: false
          },
          region: String,
          _userPool: Object
        },

        observers: [
          '_createUserPoolIdentityProvider(userPoolId, userPoolClientId)'
        ],

        // attached: function() {
          // this._cognitoRef = new AWS.CognitoIdentity();
        // }

        userPoolSignUp: function(username, password, attributes) {
          var attribute, attributeList = [];
          for (attribute in attributes) {
            attributeList.push(
              new AWSCognito.CognitoIdentityServiceProvider.CognitoUserAttribute({
                Name: attribute,
                Value: attributes[attribute]
              })
            );
          }

          this._userPool.signUp(
            username,
            password,
            attributeList,
            true,
            this._userPoolSignedUp.bind(this)
          );
        },

        userPoolSignIn: function(username, password) {
          if (!this._userPool) {
            throw new Error('no user pool');
          }

          var authenticationDetails = new AWSCognito.CognitoIdentityServiceProvider.AuthenticationDetails({
            Username: username,
            Password: password
          });

          this._cognitoUser = new AWSCognito.CognitoIdentityServiceProvider.CognitoUser({
            Username: username,
            Pool: this._userPool
          });

          this._cognitoUser.authenticateUser(authenticationDetails, {
            onSuccess: this._userPoolSignedIn.bind(this),
            onFailure: this._handleAuthenticationError.bind(this),
            mfaRequired: this._mfaRequired.bind(this),
            newPasswordRequired: this._newPasswordRequired.bind(this)
          });
        },

        userPoolSignOut: function() {
          if (this.signedIn && this._cognitoUser) {
            this._cognitoUser.signOut();
            this.set('signedIn', false);
          }
        },

        _userPoolSignedUp: function (error, result) {
          if (error) {
            this.fire('sign-up-failed', error);
            return;
          }

          this.fire('signed-up', result);
        },

        _userPoolSignedIn: function(result) {
          this.set('signedIn', true);
          this._setCognitoCredentials(result.getIdToken().getJwtToken());
        },

        _requestVerificationCode: function(data) {
          this.fire('password-reset-code-sent', data.CodeDeliveryDetails);
        },

        _handleAuthenticationError: function(error) {
          if (error.code === 'PasswordResetRequiredException') {
            this.fire('password-reset-required');
          }
        },

        _newPasswordRequired: function(userAttributes, requiredAttributes) {
          this.fire('new-password-required');
        },

        _mfaRequired: function(codeDeliveryDetails) {
          this.fire('mfa-required', codeDeliveryDetails);
        },

        /**
         * On success: fire:
ObjectAttributeName: "email"
DeliveryMedium: "EMAIL"
Destination: "j***@r***.com"
         */
        userPoolForgotPassword: function(username) {
          if (!this._userPool) {
            throw new Error('no user pool');
          }

          this._cognitoUser = new AWSCognito.CognitoIdentityServiceProvider.CognitoUser({
            Username: username,
            Pool: this._userPool
          });

          this._cognitoUser.forgotPassword({
            inputVerificationCode: this._requestVerificationCode.bind(this)
          });
        },

        userPoolConfirmPassword: function(verficationCode, newPassword) {
          this._cognitoUser.confirmPassword(verficationCode, newPassword);
        },

        userPoolNewPassword: function(newPassword) {
          this._cognitoUser.completeNewPasswordChallenge(
            newPassword,
            {},
            this._userPoolNewPasswordResponse.bind(this)
          );
        },

        userPoolChangePassword: function(oldPassword, newPassword) {
          this._cognitoUser.changePassword(
            oldPassword,
            newPassword,
            this._userPoolChangePasswordResponse.bind(this)
          );
        },

        userPoolSendMFACode: function() {
// @todo: implement
        },

        _userPoolNewPasswordResponse: function(error, result) {
          if (error) {
            this.fire('new-password-failed', error);
            return;
          }

          this.set('signedIn', true);
          this._setCognitoCredentials(result.getIdToken().getJwtToken());
          this.fire('new-password-set');
        },

        _userPoolChangePasswordResponse: function(error, result) {
          if (error) {
            this.fire('password-change-failed', error);
            return;
          }

          this.set('signedIn', true);
          this._setCognitoCredentials(result.getIdToken().getJwtToken());
          this.fire('password-changed');
        },

        _createUserPoolIdentityProvider: function(poolId, clientId) {
          if (poolId && clientId) {
            this._userPool = new AWSCognito.CognitoIdentityServiceProvider.CognitoUserPool({
              UserPoolId: poolId,
              ClientId: clientId
            });

            this._cognitoUser = this._userPool.getCurrentUser();

            if (this._cognitoUser !== null) {
              this._cognitoUser.getSession(this._userPoolSession.bind(this));
            }
          }
        },

        _userPoolSession: function(error, session) {
          if (error) {
            throw new Error('Could not get session', error);
          }

          if (session.isValid()) {
            this.set('signedIn', true);
            this._setCognitoCredentials(session.getIdToken().getJwtToken());
          }
        },

        _setCognitoCredentials: function(token) {
          var logins = {};
          logins['cognito-idp.' + this.region + '.amazonaws.com/' + this.userPoolId] = token;
          AWS.config.credentials = new AWS.CognitoIdentityCredentials({
            identityPoolId: this.identityPoolId,
            Logins: logins
          });
          logins = null;
        }
      });
    })();
  </script>
</dom-module>